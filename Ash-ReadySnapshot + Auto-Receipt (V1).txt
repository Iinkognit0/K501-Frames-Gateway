#!/bin/ash
set -eu

BASE="/GXEARC"
IDX="$BASE/index.ndjson"
RCP="$BASE/receipts.ndjson"
FRAMES="$BASE/frames"

echo "---- A) tail index ----"
tail -n 25 "$IDX" || true
echo

echo "---- B) last PRESENCE ----"
tail -n 60 "$IDX" | grep '"t":"PRESENCE"' | tail -n 12 || true
echo

echo "---- C) newest files in /GXEARC/frames ----"
ls -lt "$FRAMES" | head || true
echo

# --- Determine newest file (non-dir) in /GXEARC/frames ---
NEWEST="$(ls -t "$FRAMES" 2>/dev/null | head -n 1 || true)"
if [ -z "${NEWEST}" ]; then
  echo "ERROR: no files in $FRAMES"
  exit 1
fi

FULL="$FRAMES/$NEWEST"
if [ ! -f "$FULL" ]; then
  echo "ERROR: newest entry is not a file: $FULL"
  exit 1
fi

REL="frames/$NEWEST"
BYTES="$(wc -c < "$FULL" | tr -d ' ')"
SHA="$(sha256sum "$FULL" | awk '{print $1}')"

TS="$(date -u +%s)"
UTC="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
RID="GX-RECEIPT-CAGE-EMIT-$TS-0001"

echo "---- NEWEST (detected) ----"
echo "path=$REL"
echo "bytes=$BYTES"
echo "sha256=$SHA"
echo

# --- Append Receipt_V1 (append-only) ---
# Guard: do not duplicate same RID (rare, but safe)
if [ -f "$RCP" ] && grep -q "\"id\":\"$RID\"" "$RCP" 2>/dev/null; then
  echo "NOTICE: receipt id already exists (no append): $RID"
else
  printf '%s\n' \
'{"t":"RECEIPT_V1","id":"'"$RID"'","ts_unix":'"$TS"',"ts_utc":"'"$UTC"'","vis":"PUBLIC","p":{"op":"CAGE_EMIT","method":"LOCAL_WRITE","base":"'"$BASE"'","path":"'"$REL"'","bytes":'"$BYTES"',"sha256":"'"$SHA"'","bindings":{"presence_scan":"gx_presence_scan_v1_1","index":"index.ndjson","receipts":"receipts.ndjson"}}}' \
>> "$RCP"
  echo "OK: appended receipt -> $RCP"
fi

echo
echo "---- Proof: receipts tail + file hash ----"
tail -n 3 "$RCP" || true
wc -c "$RCP" || true
sha256sum "$RCP" || true
echo

echo "---- Cross-proof: path present in index + receipts ----"
grep -n "$REL" "$IDX" | tail -n 3 || echo "INDEX: NOT_FOUND"
grep -n "$REL" "$RCP" | tail -n 3 || echo "RECEIPTS: NOT_FOUND"